<!DOCTYPE html>
<meta charset="utf-8">
<script src="/js/plugins/jquery/jquery-3.2.1.min.js"></script>
<script src="/js/plugins/d3/d3.min.js"></script>
<script src="/js/plugins/Lodash/lodash.js"></script>
<script src="/js/d3_Graphics/pelotitas.js"></script>
<script src="/css/Semantic-UI-CSS-master-2.2/semantic.min.js"></script>
<link href="/css/Semantic-UI-CSS-master-2.2/semantic.css" rel="stylesheet" />
<link href="/css/pelotitas.css" rel="stylesheet" />
<style>
</style>
<script>
    var App = { root: window.graph, links: [[]], level: 0 }
    App.root.prepare(3)

    $(document).ready(function () {
        $('#cleaner').click(function () {
            $('circle').not('.Mark').parent().addClass('hidden')
            $('line').not('.Mark').parent().addClass('hidden')
        })
        $('#next').click(function () {


            App.level++
            if (App.links[App.level] == null)
                App.links[App.level] = []

            function go(_e, _t, callback, go) {
                
                if (_e < _t) {
                    $('#next').addClass('hidden')
                    var _n = App.links[App.level - 1][_e]
                    App.root.expandNode(_n, function (t) {
                        App.root.addRelationsToGraph(_n, t);
                        _e++
                        go(_e, _t, callback, go)
                        App.root.update()
                    })
                } else {
                    $('#next').removeClass('hidden')
                    callback()
                }

            }

            go(0, App.links[App.level - 1].length, function () {



            }, go)

            //debugger
        })

        $.getJSON('/relations/3f7b6024-5327-4604-83ec-54bad8e6c45f', function (data) {
            //debugger

            
            App.root.createBaseGraph(data, function (LastLoad, _parentData) {
                //debugger
                if (App.links[App.level] == null)
                    App.links[App.level] = []
                //debugger
                if (_.isArray(LastLoad)) {

                    var _diff = App.level > 1 ? _.differenceBy(LastLoad, App.links[App.level - 2], 'Id') : LastLoad
                    var _diff = App.links[App.level].length > 0 ? _.differenceBy(_diff, App.links[App.level], 'Id') : _diff
                    App.links[App.level] = _.unionBy(_diff, App.links[App.level], 'Id')
                } else {
                    if (App.level == 0) {
                        var _diff = [LastLoad]
                        App.links[App.level] = _.unionBy(_diff, App.links[App.level], 'Id')
                    }
                }

                var _Dom = function (id, origin, callback) {
                    callback(_.findIndex(App.root.links, function (o) {
                        //if (o.target.Id == id)
                        //    debugger
                        return o[origin].Id == id
                    }), origin,
                    )
                }
                var _Cont = function (counter, origin) {
                    if (counter > 0) {
                        $('circle[data_key=' + App.root.links[counter]['target'].Id + ']').addClass('Mark')
                        $('line[data_target=' + App.root.links[counter]['source'].Id + ']').addClass('Mark')
                        debugger
                        ///if (origin == 'target') {
                        //    var newOrigin = 'source'
                        //} else {
                        //    var newOrigin = 'target'
                        //}
                        _Dom(App.root.links[counter]['source'].Id, 'target', _Cont)
                    }
                }

                var _Mark = _.find(LastLoad, function (o) { return o.Mark != null; });
                if (_Mark != null) {
                    $('#cleaner').removeClass('hidden')

                    _Dom(_Mark.Id, 'target', _Cont)
                    //debugger
                }
                //}
                if (App.level == 0)
                    App.level++


                

            }, function (_r) {
                //debugger
            })
        })
    })
</script>
<body>

    <div id="graph_container">

        <svg id="relations">
            <title>Mapa de empresas y directivos relacionados con </title>
            <desc>Este mapa interactivo permite visualizar las relaciones entre empresas y cargos directivos.</desc>
            <g z-order="1000"></g>
            <g>
                <g id="links"></g>
                <g id="nodes"></g>
                <g id="nodetexts"></g>
            </g>

        </svg>

        <div id="ui">
            <div id="topleft">
                <h1>Diagrama de relaciones</h1>
                <a id="next">Siguiente</a>
                <a id="cleaner" class="hidden">Limpiar</a>
                <div id="help" class="overlay" style="display: none;">
                    <div id="content">
                        <span id="closehelp" class="glyphicon glyphicon-remove"></span>
                        <ul>
                            <li>Click en un círculo de empresa o directivo para cargar sus relaciones.</li>
                            <li>Al arrastrar un círculo su posición se queda anclada en el diagrama. Doble click para liberarlo.</li>
                            <li>Click sobre un nombre de empresa o directivo lo abre en otra ventana.</li>
                            <li>Al arrastrar sobre el fondo, se mueve todo el diagrama.</li>
                            <li>Al mover el ratón sobre un enlace aparecen los cargos.</li>
                        </ul>
                        <svg>
                            <circle cx="12" cy="20" r="7" class="node company"></circle>
                            <text x="30" y="24">Empresas</text>
                            <circle cx="12" cy="40" r="7" class="node person"></circle>
                            <text x="30" y="44">Directivos</text>
                            <circle cx="12" cy="60" r="7" class="node person juridic"></circle>
                            <text x="30" y="64">Directivos (personas jurídicas)</text>
                            <line x1="3" x2="22" y1="80" y2="80" class="link activelink"></line>
                            <text x="30" y="84">Cargos activos</text>
                            <line x1="3" x2="22" y1="100" y2="100" class="link inactivelink"></line>
                            <text x="30" y="104">Cargos no activos</text>
                            <circle cx="12" cy="120" r="7" class="node fixed"></circle>
                            <text x="30" y="124">Elemento anclado</text>
                            <circle cx="12" cy="140" r="6" class="nodenumrelsback"></circle>
                            <text x="30" y="144">Número de relaciones</text>
                        </svg>
                    </div>
                </div>
            </div>


        </div>

    </div>

    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
        <symbol id="business-person-silhouette-wearing-tie" viewBox="0 0 81.016 81.016">
            <title>business-person-silhouette-wearing-tie</title>
            <circle cx="40.509" cy="17.217" r="17.217" />
            <path d="M47.811,35.606H33.203c-12.152,0-22.041,9.888-22.041,22.042v17.869l0.045,0.279l1.232,0.385 c11.598,3.623,21.676,4.834,29.971,4.834c16.199,0,25.59-4.621,26.172-4.914l1.15-0.584h0.121V57.648 C69.854,45.494,59.967,35.606,47.811,35.606z M43.91,70.283l-3.152,4.613c-0.043,0.063-0.111,0.1-0.186,0.1 c-0.002,0-0.004,0-0.006,0c-0.074,0-0.145-0.039-0.186-0.104l-2.928-4.616c-0.025-0.039-0.037-0.086-0.035-0.136l1.465-22.403 c0.008-0.119,0.105-0.209,0.225-0.209h3.039c0.119,0,0.217,0.09,0.227,0.209l1.574,22.401 C43.953,70.191,43.938,70.24,43.91,70.283z M42.484,46.85h-3.613l-3.141-6.492c0-0.623,0.504-1.125,1.127-1.125H44.4 c0.621,0,1.125,0.502,1.125,1.125L42.484,46.85z" />
        </symbol>
        <symbol id="factory" viewBox="0 0 412 412">
            <title>factory</title>
            <g>
                <g>
                    <path d="M380,399.2h-28v-176c0-3.2-2.4-6.4-6.4-6.4h-11.2l-17.6-109.6c-0.8-3.2-3.2-4.8-5.6-4.8h-36c-3.2,0-5.6,2.4-5.6,4.8 L252,216.8h-22.4v-47.2c0-2.4-1.6-4-3.2-5.6c-2.4-0.8-4.8-0.8-6.4,0.8l-69.6,52v-47.2c0-2.4-1.6-4-3.2-5.6 c-2.4-0.8-4.8-0.8-6.4,0.8l-69.6,52h-9.6c-3.2,0-6.4,2.4-6.4,6.4v176h-24c-3.2,0-6.4,2.4-6.4,6.4c0,3.2,2.4,6.4,6.4,6.4h30.4h40 h104h140.8h34.4c3.2,0,6.4-2.4,6.4-6.4C386.4,402.4,383.2,399.2,380,399.2z M280,114.4h25.6l16.8,102.4H264L280,114.4z M217.6,181.6v35.2h-47.2L217.6,181.6z M138.4,181.6v35.2H91.2L138.4,181.6z M147.2,399.2h-40v-76.8h40V399.2z M199.2,399.2h-40 v-76.8h40V399.2z M339.2,399.2H212v-82.4c0-3.2-2.4-6.4-6.4-6.4H100.8c-3.2,0-6.4,2.4-6.4,6.4V400h-28V228.8H72h71.2h8h71.2H256 h72.8h10.4V399.2z" />
                </g>
            </g>
            <g>
                <g>
                    <path d="M316.8,28.8c0-0.8,0-1.6,0-2.4c0-14.4-12-26.4-26.4-26.4C276,0,264,12,264,26.4c0,0.8,0,1.6,0,2.4 c-4.8,4.8-9.6,12-9.6,19.2c0,8,4.8,14.4,12,19.2c0,6.4,2.4,12,6.4,16.8c2.4,2.4,5.6,2.4,8.8,0.8c2.4-2.4,2.4-5.6,0.8-8.8 c-2.4-2.4-3.2-5.6-3.2-9.6c0-0.8,0-0.8,0-1.6c0-2.4-0.8-4.8-3.2-6.4c-5.6-3.2-9.6-7.2-9.6-10.4c0-4,4-8,9.6-11.2 c2.4-1.6,4-4,3.2-7.2c-0.8-1.6-0.8-3.2-0.8-4c0-8,6.4-14.4,14.4-14.4s14.4,6.4,14.4,14.4c0,0.8,0,2.4-0.8,4 c-0.8,3.2,0.8,5.6,3.2,7.2c6.4,3.2,9.6,7.2,9.6,11.2s-3.2,8-9.6,10.4c-2.4,0.8-4,4-3.2,6.4c0,0.8,0,0.8,0,1.6c0,4-1.6,8-4.8,10.4 c-2.4,2.4-2.4,6.4,0,8.8c0.8,1.6,2.4,1.6,4,1.6c1.6,0,3.2-0.8,4-1.6c4.8-4.8,8-11.2,8-18.4c8-4.8,12-12,12-19.2 C329.6,40,324.8,33.6,316.8,28.8z" />
                </g>
            </g>
            <g>
                <g>
                    <path d="M148.8,259.2h-40c-3.2,0-6.4,2.4-6.4,6.4c0,3.2,2.4,6.4,6.4,6.4h40c3.2,0,6.4-2.4,6.4-6.4 C155.2,262.4,152.8,259.2,148.8,259.2z" />
                </g>
            </g>
            <g>
                <g>
                    <path d="M216,259.2h-40c-3.2,0-6.4,2.4-6.4,6.4c0,3.2,2.4,6.4,6.4,6.4h40c3.2,0,6.4-2.4,6.4-6.4 C221.6,262.4,219.2,259.2,216,259.2z" />
                </g>
            </g>
            <g>
                <g>
                    <path d="M282.4,258.4h-40c-3.2,0-6.4,2.4-6.4,6.4c0.8,4,3.2,6.4,6.4,6.4h40c3.2,0,6.4-2.4,6.4-6.4 C288.8,261.6,286.4,258.4,282.4,258.4z" />
                </g>
            </g>
            <g>
                <g>
                    <path d="M296,310.4h-56c-3.2,0-6.4,2.4-6.4,6.4v41.6c0,3.2,2.4,6.4,6.4,6.4h56c3.2,0,6.4-2.4,6.4-6.4v-41.6 C301.6,313.6,299.2,310.4,296,310.4z M289.6,352h-44v-29.6h44V352z" />
                </g>
            </g>
        </symbol>
    </svg>

</body>